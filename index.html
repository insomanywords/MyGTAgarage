<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <title>My GTA Garage v34.9.3</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23121212%22 rx=%2220%22/><text y=%2250%22 x=%2250%22 dy=%22.35em%22 text-anchor=%22middle%22 fill=%22%239b59b6%22 font-family=%22sans-serif%22 font-weight=%22bold%22 font-size=%2260%22>G</text></svg>">

    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --head: #181818;
            --text: #ffffff; --text-dim: #a0a0a0; --accent: #9b59b6;
            --wep: #ef4444; --f1: #f59e0b; --benny: #3b82f6; --sell: #22c55e; --timer: #f97316;
            --border: #333; --radius: 8px;
            
            /* Plates */
            --pl-yankton: #ffd700; --pl-liberty: #1e3a8a; --pl-panic: #6366f1;
            --pl-pound: #3b82f6; --pl-venturas: #b91c1c; --pl-ecola: #dc2626; --pl-sprunk: #16a34a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text);
            margin: 0; padding: 0; display: flex; flex-direction: column; 
            height: 100dvh; /* FIXED: Dynamic Height for Android */
            overflow: hidden;
        }

        /* HEADER */
        header {
            background-color: #000; padding: 12px 16px; border-bottom: 2px solid var(--accent);
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; z-index: 50; gap: 10px;
        }
        
        .header-info { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
        
        /* Desktop Title */
        h1 { margin: 0; font-size: 1.1rem; text-transform: uppercase; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Mobile Logo (Hidden by default) */
        .header-logo-img { width: 32px; height: 32px; display: none; }

        .total-badge { 
            background: #333; padding: 4px 8px; border-radius: 4px; 
            font-size: 0.8rem; font-weight: bold; color: #fff; border: 1px solid var(--border); 
            white-space: nowrap; flex-shrink: 0;
        }

        .header-actions { display: flex; gap: 6px; flex-shrink: 0; }

        /* Header Responsive Logic */
        @media (max-width: 450px) { 
            h1 { display: none; } 
            .header-logo-img { display: block; }
        }

        /* CONTROLS */
        .controls {
            padding: 10px; background-color: var(--head); border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 10px; flex-shrink: 0;
        }
        
        .search-wrapper { position: relative; width: 100%; }
        .search-wrapper i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-dim); pointer-events: none; }
        .search-wrapper input { padding-left: 38px !important; padding-right: 35px !important; width: 100%; height: 44px; }
        .clear-search { position: absolute; right: 0; top: 0; height: 100%; width: 40px; display: none; align-items: center; justify-content: center; color: var(--text-dim); cursor: pointer; }

        .filter-row { display: flex; gap: 8px; width: 100%; }
        #viewMode { flex-grow: 1; width: auto; min-width: 0; }
        .filter-row button { flex-shrink: 0; width: auto; white-space: nowrap; }

        @media (min-width: 768px) {
            .controls { flex-direction: row; align-items: center; }
            .search-wrapper { flex: 1; }
            .filter-row { width: auto; min-width: 400px; flex-shrink: 0; }
        }

        input, select {
            padding: 10px 12px; border-radius: var(--radius); border: 1px solid #333;
            background: #252525; color: white; font-size: 16px; outline: none; transition: border-color 0.2s; height: 44px;
            width: 100%;
        }
        input:focus, select:focus { border-color: var(--accent); }

        button { border: none; padding: 0 16px; border-radius: var(--radius); font-weight: 600; cursor: pointer; height: 44px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s; }
        .btn-pri { background: var(--accent); color: #fff; }
        .btn-sec { background: #2c2c2c; color: #ccc; border: 1px solid #333; }
        .timer-btn { background: #1a1a1a; border: 1px solid var(--sell); color: var(--sell); font-weight: bold; min-width: 50px; }
        .timer-btn.active { border-color: var(--timer); color: var(--timer); }

        /* LIST */
        #vehicle-list { flex-grow: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; padding-bottom: 80px; }
        .vehicle-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 8px; }
        @media (min-width: 600px) { .vehicle-grid { grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); } }
        .vehicle-grid.hidden { display: none !important; }

        /* GROUPS */
        .group-header {
            background: #252525; padding: 12px 15px; border-radius: var(--radius); margin-top: 15px;
            font-weight: 700; color: var(--accent); 
            display: flex; flex-wrap: wrap; 
            justify-content: space-between; align-items: center;
            cursor: pointer; border: 1px solid #333; position: relative; overflow: hidden;
            gap: 10px;
        }
        .group-name-wrap { display: flex; align-items: center; flex: 1; min-width: 50%; }
        .group-header.collapsed .arrow { transform: rotate(-90deg); }
        .arrow { display: inline-block; transition: 0.2s; margin-right: 10px; color: #666; }
        .group-meta { font-size: 0.8rem; color: var(--text-dim); z-index: 2; white-space: nowrap; margin-left: auto; }
        .cap-bar { position: absolute; bottom: 0; left: 0; height: 3px; background: var(--accent); opacity: 0.6; transition: width 0.3s; }

        /* CARDS */
        .card {
            background: var(--card); border-radius: 12px; overflow: hidden;
            display: flex; min-height: 115px; height: auto;
            border: 1px solid #2a2a2a; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .card-img-box { width: 130px; background: #000; flex-shrink: 0; position: relative; display: flex; align-items: center; justify-content: center; cursor: pointer; border-right: 1px solid #222; align-self: stretch; }
        .card-img { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; }
        
        .card-badges { position: absolute; bottom: 4px; left: 4px; display: flex; gap: 3px; flex-wrap: wrap; z-index: 2; }
        .badge { font-size: 0.55rem; padding: 2px 5px; border-radius: 4px; font-weight: 800; text-transform: uppercase; color: #fff; background: rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(2px); }
        .badge.w { background: var(--wep); border-color: var(--wep); }
        .badge.f { background: var(--f1); border-color: var(--f1); color: #000; }
        .badge.b { background: var(--benny); border-color: var(--benny); }
        
        /* Colored Plates */
        .badge.y { background: var(--pl-yankton); color: #000; border-color: var(--pl-yankton); }
        .badge.l { background: var(--pl-liberty); border-color: var(--pl-liberty); }
        .badge.p { background: var(--pl-panic); border-color: var(--pl-panic); }
        .badge.pd { background: var(--pl-pound); border-color: var(--pl-pound); }
        .badge.v { background: var(--pl-venturas); border-color: var(--pl-venturas); }
        .badge.e { background: var(--pl-ecola); border-color: var(--pl-ecola); }
        .badge.s { background: var(--pl-sprunk); border-color: var(--pl-sprunk); }
        
        .card-info { flex: 1; padding: 8px 12px; min-width: 0; display: flex; flex-direction: column; }
        .card-top { margin-bottom: 4px; padding-right: 75px; } 
        .card-manuf { font-size: 0.65rem; color: var(--accent); font-weight: 700; text-transform: uppercase; margin-bottom: 2px; }
        .card-model { font-size: 1.05rem; font-weight: 700; color: #fff; line-height: 1.2; white-space: normal; word-wrap: break-word; }
        
        .card-chips { display: flex; gap: 5px; margin-bottom: 6px; flex-wrap: wrap; }
        .chip { background: #252525; color: #ccc; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; display: flex; align-items: center; gap: 4px; border: 1px solid #333; }
        
        .card-loc { font-size: 0.75rem; color: var(--text-dim); border-top: 1px solid #2a2a2a; padding-top: 6px; margin-top: auto; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .card-loc i { color: var(--accent); font-size: 0.7rem; align-self: flex-start; margin-top: 2px; }
        .loc-text { white-space: normal; line-height: 1.3; display: flex; flex-direction: column; }
        .loc-floor { font-size: 0.65rem; color: #777; margin-top: 1px; }

        .card-actions-top { position: absolute; top: 0; right: 0; display: flex; height: 45px; align-items: center; padding-right: 5px; z-index: 5; }
        .action-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #444; font-size: 0.9rem; cursor: pointer; transition: 0.2s; border: none; background: transparent; }
        .action-btn:hover { color: #fff; background: rgba(255,255,255,0.05); border-radius: 4px; }
        .gtacars-link:hover { color: var(--benny); }

        /* MODALS */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; align-items: center; justify-content: center; padding: 15px; }
        .modal-box { background: #1e1e1e; width: 100%; max-width: 500px; max-height: 95vh; overflow-y: auto; border-radius: 12px; padding: 20px; border: 1px solid #333; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .modal-title { font-size: 1.3rem; font-weight: 800; margin-bottom: 20px; color: #fff; border-bottom: 1px solid #333; padding-bottom: 12px; }
        
        .modal-row { display: flex; gap: 12px; margin-bottom: 15px; flex-direction: column; }
        @media(min-width: 500px) { .modal-row { flex-direction: row; } }
        .modal-row > div { flex: 1; }
        
        .form-section { background: #252525; padding: 15px; border-radius: 10px; border: 1px solid #333; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; width: 100%; }
        .label { display: block; color: var(--text-dim); font-size: 0.75rem; margin-bottom: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 25px; }
        .modal-actions button { flex: 1; }

        .wep-toggle { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #333; border-radius: 8px; cursor: pointer; border: 1px solid #444; margin-bottom: 15px; transition: 0.2s; }
        .wep-toggle:hover { background: #3a3a3a; }
        .wep-toggle input { width: 20px; height: 20px; accent-color: var(--wep); }

        /* DASHBOARD */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        @media (min-width: 450px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }
        .stat-card { background: #252525; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #333; display: flex; flex-direction: column; justify-content: center; }
        .stat-val { font-size: 1.4rem; font-weight: 800; display: block; color: var(--accent); }
        .stat-label { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; font-weight: 700; margin-top: 4px; }
        .timer-big { font-size: 3rem; font-weight: 800; text-align: center; margin: 20px 0; color: var(--timer); font-variant-numeric: tabular-nums; }
        .usage-container { background: #111; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .usage-bar { height: 100%; background: var(--accent); width: 0%; transition: 0.5s; }

        footer { background: #111; padding: 15px; text-align: center; font-size: 0.8rem; color: #555; border-top: 1px solid #222; flex-shrink: 0; }
        footer a { color: var(--accent); text-decoration: none; margin: 0 10px; font-weight: bold; cursor: pointer; }
        
        #lightbox { display: none; position: fixed; inset: 0; background: #000; z-index: 2000; align-items: center; justify-content: center; }
        #lbImg { max-width: 95%; max-height: 90%; object-fit: contain; }
    </style>
</head>
<body>

<header>
    <div class="header-info">
        <img src="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23121212%22 rx=%2220%22/><text y=%2250%22 x=%2250%22 dy=%22.35em%22 text-anchor=%22middle%22 fill=%22%239b59b6%22 font-family=%22sans-serif%22 font-weight=%22bold%22 font-size=%2260%22>G</text></svg>" class="header-logo-img">
        <h1>My GTA Garage</h1>
        <div class="total-badge"><span class="total-label">Owned: </span><span id="headerCount">0</span></div>
    </div>
    <div class="header-actions">
        <button id="timerBtn" class="timer-btn" onclick="openTimerModal()">ðŸ’²</button>
        <button class="btn-sec" style="width:44px" onclick="openStats()">ðŸ“Š</button>
        <button class="btn-sec" style="width:44px" onclick="downloadBackup()">ðŸ’¾</button>
        <button class="btn-sec" style="width:44px" onclick="document.getElementById('restoreInput').click()">ðŸ“‚</button>
        <input type="file" id="restoreInput" style="display:none" onchange="restoreBackup(this)">
    </div>
</header>

<div class="controls">
    <div class="search-wrapper">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search collection..." onkeyup="render()">
        <div class="clear-search" id="clearSearch" onclick="clearSearch()">âœ•</div>
    </div>
    <div class="filter-row">
        <select id="viewMode" onchange="render()">
            <option value="garage">Group: Garage</option>
            <option value="manuf">Group: Brand</option>
            <option value="class">Group: Class</option>
            <option value="drive">Group: Drive</option>
            <option value="all">View All</option>
        </select>
        <button class="btn-sec" onclick="openSwapAllModal()"><i class="fas fa-exchange-alt"></i></button>
        <button class="btn-pri" onclick="openAddModal()">+ Add</button>
    </div>
</div>

<div id="vehicle-list"></div>

<footer>
    <span>v34.9.3</span> | 
    <a onclick="openModal('changelogModal')">Changelog</a> | 
    <a onclick="factoryReset()" style="color: #ef4444">Reset</a>
</footer>

<div id="vehicleModal" class="modal">
    <div class="modal-box">
        <div id="modalTitle" class="modal-title">Vehicle Details</div>
        
        <div class="modal-row">
            <div>
                <span class="label">Make</span>
                <select id="inManuf" onchange="updateModelDD()"></select>
            </div>
            <div>
                <span class="label">Model</span>
                <select id="inModel" onchange="checkCustomModel()"></select>
            </div>
        </div>
        <input type="text" id="inModelCustom" class="form-group" style="display:none; width:100%; margin-top:-10px;" placeholder="Enter custom model">

        <div class="form-group">
            <span class="label">Garage</span>
            <select id="inLoc" onchange="handleLocChange()"></select>
        </div>
        <input type="text" id="inLocCustom" class="form-group" style="display:none; width:100%; margin-top:-10px;" placeholder="Enter custom garage">

        <div id="floorRow" style="display:none;" class="modal-row">
            <div style="flex:2">
                <span class="label">Floor</span>
                <select id="inFloor"></select>
            </div>
            <div style="flex:1"><span class="label">Slot</span><input type="number" id="inSlot" placeholder="#"></div>
        </div>

        <div class="form-section">
            <label class="wep-toggle">
                <span style="font-weight:700; color:#fff;">Weaponized Vehicle</span>
                <input type="checkbox" id="inWep">
            </label>
            <div class="modal-row" style="margin-bottom:0;">
                <div><span class="label">Wheels</span><select id="inWheels"><option value="Stock">Stock</option><option value="F1">F1 Wheels</option><option value="Benny">Benny's</option></select></div>
                <div><span class="label">Plate</span><select id="inPlate">
                    <option value="Standard">Standard</option><option value="Yankton">Yankton</option>
                    <option value="Liberty City">Liberty City</option><option value="Panic">Panic</option>
                    <option value="Pounders">Pounders</option><option value="Las Venturas">Las Venturas</option>
                    <option value="E-Cola">E-Cola</option><option value="Sprunk">Sprunk</option>
                </select></div>
            </div>
        </div>

        <div class="form-group"><span class="label">Notes</span><input type="text" id="inNotes" style="width:100%" placeholder="Paint, livery, upgrades..."></div>

        <div class="modal-actions">
            <button class="btn-sec" onclick="closeModal('vehicleModal')">Cancel</button>
            <button class="btn-primary" onclick="saveVehicle()">Save</button>
        </div>
        
        <div id="editActions" style="display:none; margin-top:20px; flex-direction:column; gap:8px; border-top:1px solid #333; padding-top:15px;">
            <button onclick="startMove()" style="background:#2980b9; color:#fff; width:100%"><i class="fas fa-exchange-alt"></i> Move Vehicle</button>
            <button onclick="sellVehicle()" style="background:var(--sell); color:#fff; width:100%"><i class="fas fa-dollar-sign"></i> Sell (18h Timer)</button>
            <button onclick="deleteVehicle()" style="background:var(--wep); color:#fff; width:100%"><i class="fas fa-trash"></i> Delete Permanent</button>
        </div>
    </div>
</div>

<div id="statsModal" class="modal">
    <div class="modal-box">
        <div class="modal-title">Garage Stats</div>
        <div class="stats-grid">
            <div class="stat-card"><span id="stTotal" class="stat-val">0</span><span class="stat-label">Total</span></div>
            <div class="stat-card"><span id="stWep" class="stat-val" style="color:var(--wep)">0</span><span class="stat-label">Weapon</span></div>
            <div class="stat-card"><span id="stF1" class="stat-val" style="color:var(--f1)">0</span><span class="stat-label">F1</span></div>
            <div class="stat-card"><span id="stBenny" class="stat-val" style="color:var(--benny)">0</span><span class="stat-label">Benny</span></div>
        </div>
        
        <div class="form-section">
            <div style="display:flex; justify-content:space-between; font-weight:800; margin-bottom:5px;">
                <span class="label">Global Capacity</span>
                <span id="usageTxt" style="color:#fff;">0/0</span>
            </div>
            <div class="usage-container"><div id="usageBar" class="usage-bar"></div></div>
            <div style="margin-top:10px; font-size:0.8rem; color:#aaa; text-align:center;">
                <span id="stEmptySlots" style="color:var(--sell); font-weight:bold;">0</span> empty slots available
            </div>
        </div>
        
        <div class="form-section">
            <span class="label">Top 5 Brands</span>
            <ul id="stBrands" style="color:#ccc; padding-left:20px; line-height:1.6; margin:0; font-size:0.9rem;"></ul>
        </div>
        <button class="btn-pri" style="width:100%" onclick="closeModal('statsModal')">Close</button>
    </div>
</div>

<div id="successModal" class="modal">
    <div class="modal-box" style="text-align:center;">
        <div style="font-size:3rem; margin-bottom:10px;">âœ…</div>
        <h2 id="successTitle" style="margin:0 0 10px 0; color:#fff;">Success</h2>
        <p id="successMsg" style="color:#ccc; font-size:0.95rem; line-height:1.5;"></p>
        <button class="btn-pri" style="width:100%; margin-top:20px;" onclick="closeModal('successModal')">Awesome</button>
    </div>
</div>

<div id="timerModal" class="modal">
    <div class="modal-box">
        <div class="modal-title">Sales Dashboard</div>
        <div style="text-align:center; padding:10px 0;">
            <span class="label">Cooldown Status</span>
            <div id="timerBigDisplay" class="timer-big">READY</div>
            <div id="dashNext" style="color:var(--accent); font-weight:bold; font-size:1rem;">Ready Now</div>
        </div>
        <div style="display:flex; justify-content:space-between; background:#252525; padding:15px; border-radius:10px; margin-top:20px; align-items:center;">
            <span class="label" style="margin:0">Last Sold:</span>
            <span id="dashLast" style="font-weight:bold; color:#fff;">--</span>
        </div>
        <button class="btn-pri" style="margin-top:20px; width:100%" onclick="closeModal('timerModal')">Close</button>
    </div>
</div>

<div id="swapAllModal" class="modal"><div class="modal-box"><div class="modal-title">Swap Entire Garage</div><div class="form-group"><span class="label">From</span><select id="saFrom" style="width:100%"></select></div><div style="text-align:center; padding:10px;"><i class="fas fa-arrow-down" style="color:var(--accent); font-size:1.5rem;"></i></div><div class="form-group"><span class="label">To</span><select id="saTo" style="width:100%"></select></div><div class="modal-actions"><button class="btn-sec" onclick="closeModal('swapAllModal')">Cancel</button><button class="btn-pri" onclick="performSwapAll()">Confirm Swap</button></div></div></div>
<div id="moveModal" class="modal"><div class="modal-box"><div class="modal-title">Move Vehicle</div><p id="moveCarName" style="color:var(--accent); font-weight:bold; margin-bottom:20px; font-size:1.1rem;"></p><div class="form-group"><span class="label">Destination</span><select id="moveDest" style="width:100%" onchange="checkMoveCap()"></select></div><div id="moveSwapUI" style="display:none; background:rgba(245,158,11,0.1); padding:15px; border-radius:10px; border:1px solid var(--f1); margin-bottom:15px;"><span class="label" style="color:var(--f1)">Garage Full! Select car to swap with:</span><select id="moveSwapTarget" style="width:100%"></select></div><div class="modal-actions"><button class="btn-sec" onclick="closeModal('moveModal')">Cancel</button><button class="btn-pri" onclick="commitMove()">Confirm Move</button></div></div></div>
<div id="migrationModal" class="modal"><div class="modal-box"><div class="modal-title" style="color:var(--accent)">Data Migration</div><p style="color:#ccc; font-size:0.9rem;">Syncing vehicle data with cloud database (Images & Drive stats).</p><div id="migLog" style="height:120px; overflow:auto; background:#000; padding:10px; font-family:monospace; color:var(--sell); border-radius:8px;"></div><div class="modal-actions"><button class="btn-sec" onclick="closeModal('migrationModal')">Cancel</button><button class="btn-pri" onclick="runMigration()">Run Update</button></div></div></div>
<div id="changelogModal" class="modal"><div class="modal-box"><div class="modal-title">History</div><div style="color:#ccc; font-size:0.85rem; line-height:1.6; max-height:300px; overflow:auto;"><p><strong>v34.9.3 (Current)</strong><br>â€¢ Android Keyboard Optimization (Viewport).<br>â€¢ Header Logo for Mobile.<br>â€¢ Reverted to Native Dropdowns for stability.<br>â€¢ Migration Failure Log.</p><p><strong>v34.9.1</strong><br>â€¢ Fixed Class Names.<br>â€¢ Added Group by Class/Drive.</p></div><button class="btn-pri" style="width:100%; margin-top:15px;" onclick="closeModal('changelogModal')">Close</button></div></div>
<div id="lightbox" onclick="this.style.display='none'"><img id="lbImg"></div>

<script>
    // --- 1. CONFIG & DB ---
    const STORAGE_KEY = 'gta_vehicles_v1';
    const BASE_URL = "https://raw.githubusercontent.com/insomanywords/MyGTAgarage-images/main/";
    const DB_URL = BASE_URL + "vehicles.json";

    let masterDB = [];
    let vehicles = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let lastSell = parseInt(localStorage.getItem('gta_last_sale')) || 0;
    let lastSoldName = localStorage.getItem('gta_last_sold_name') || "None";
    let editingId = null;
    let timerInt = null;
    let movingId = null;

    const GARAGE_DATA = [
        { grp: "Safehouses", items: ["Richman Villa (20)", "The Vinewood Residence (20)", "The Tongva Estate (20)", "Mansion (10)"] },
        { grp: "Massive", items: ["Vinewood Club Garage (100)", "Eclipse Blvd Garage (50)", "Office Garage 1 (20)", "Office Garage 2 (20)", "Office Garage 3 (20)"] },
        { grp: "Apartments", items: ["Eclipse Towers, Penthouse 1 (10)", "Eclipse Towers, Penthouse 2 (10)", "Eclipse Towers, Penthouse 3 (10)", "Eclipse Towers, Apt 31 (10)", "Eclipse Towers, Apt 9 (10)", "Eclipse Towers, Apt 5 (10)", "Eclipse Towers, Apt 3 (10)", "Richards Majestic, Apt 51 (10)", "Richards Majestic, Apt 4 (10)", "Tinsel Towers, Apt 42 (10)", "Tinsel Towers, Apt 29 (10)", "4 Integrity Way, Apt 30 (10)", "4 Integrity Way, Apt 35 (10)", "Del Perro Heights, Apt 7 (10)", "Del Perro Heights, Apt 20 (10)", "Weazel Plaza, Apt 101 (10)", "Weazel Plaza, Apt 70 (10)", "Weazel Plaza, Apt 26 (10)", "3 Alta St, Apt 10 (10)", "3 Alta St, Apt 57 (10)"] },
        { grp: "Business", items: ["Agency (20)", "Nightclub (31)", "Arcade (10)", "Auto Shop (10)", "Salvage Yard (2)", "Bail Enforcement (2)", "Clubhouse (10)"] },
        { grp: "Special", items: ["Arena Workshop (27)", "Casino Penthouse (10)", "Facility (7)", "Kosatka", "Terrorbyte", "Acid Lab", "Avenger", "MOC"] }
    ];

    const CAPACITIES = {
        "Vinewood Club": 100, "Eclipse Blvd": 50, "Office": 20, "Agency": 20, "Nightclub": 31, 
        "Arena Workshop": 27, "Facility": 7, "Arcade": 10, "Auto Shop": 10, "Richman Villa": 20,
        "Vinewood Residence": 20, "Tongva Estate": 20, "Salvage Yard": 2, "Bail Enforcement": 2, 
        "Clubhouse": 10, "DEFAULT": 10
    };

    const FLOOR_MAP = {
        "Vinewood Club": ["Main Floor"],
        "Eclipse Blvd": ["Floor 1", "Floor 2", "Floor 3", "Floor 4", "Floor 5"],
        "Office": ["Floor 1", "Floor 2", "Floor 3"],
        "Nightclub": ["Service Entrance", "Basement 2", "Basement 3", "Basement 4"],
        "Arena Workshop": ["Workshop Level", "Basement 1", "Basement 2"]
    };

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        render(); 
        updateTimerLogic();
        populateDropdowns(); 
        
        try {
            const res = await fetch(DB_URL);
            if(res.ok) {
                masterDB = await res.json();
                populateDropdowns(); // Re-populate to add Cloud Brands
                if(vehicles.length > 0 && !vehicles[0].spawn) openModal('migrationModal');
            }
        } catch(e) { console.log("Offline mode active."); }
    });

    // --- RENDER LOGIC ---
    function render() {
        const list = document.getElementById('vehicle-list'), term = document.getElementById('searchInput').value.toLowerCase(), mode = document.getElementById('viewMode').value;
        const filtered = vehicles.filter(v => (v.model+v.manuf+v.loc+(v.notes||'')).toLowerCase().includes(term));
        
        const countEl = document.getElementById('headerCount');
        if(countEl) countEl.innerText = vehicles.length;
        
        const xBtn = document.getElementById('clearSearch');
        if(xBtn) xBtn.style.display = term.length > 0 ? 'flex' : 'none';

        list.innerHTML = "";

        if(mode === 'all') {
            const grid = document.createElement('div'); grid.className = 'vehicle-grid';
            filtered.forEach(v => grid.appendChild(createCard(v)));
            list.appendChild(grid);
        } else {
            const groups = {};
            filtered.forEach(v => { 
                let k = "Unknown";
                const db = masterDB.find(d => d.model === v.model) || {};
                
                if (mode === 'garage') k = v.loc;
                else if (mode === 'manuf') k = v.manuf;
                else if (mode === 'class') k = (db.class || v.class || 'Unknown').replace(/_/g, ' ');
                else if (mode === 'drive') k = db.drive || v.drive || 'Unknown';
                
                if(!groups[k]) groups[k] = []; 
                groups[k].push(v); 
            });
            
            Object.keys(groups).sort().forEach(k => {
                const head = document.createElement('div'); head.className = term ? 'group-header' : 'group-header collapsed';
                let meta = `${groups[k].length}`; 
                let pct = 0;
                
                if(mode==='garage') { 
                    const cl = Object.keys(CAPACITIES).find(m=>k.includes(m))||"DEFAULT"; 
                    const cap=CAPACITIES[cl]; 
                    meta = `${groups[k].length} / ${cap}`; 
                    pct = (groups[k].length/cap)*100; 
                }
                
                head.innerHTML = `
                    <div class="group-name-wrap"><span class="arrow">â–¼</span>${k}</div>
                    <span class="group-meta">${meta}</span>
                    <div class="cap-bar" style="width:${Math.min(pct,100)}%; background:${pct>=90?'#ef4444':'var(--accent)'}"></div>
                `;
                
                const grid = document.createElement('div'); grid.className = term ? 'vehicle-grid' : 'vehicle-grid hidden';
                groups[k].forEach(v => grid.appendChild(createCard(v)));
                head.onclick = () => { grid.classList.toggle('hidden'); head.classList.toggle('collapsed'); };
                list.appendChild(head); list.appendChild(grid);
            });
        }
    }

    function createCard(v) {
        const db = masterDB.find(d => d.model === v.model) || {}, spawn = db.spawn || v.spawn || "";
        const img = spawn ? `${BASE_URL}vehicles/${spawn.toLowerCase().trim()}.png` : "";
        const gtaUrl = spawn ? `https://gtacars.net/gta5/${spawn.toLowerCase().replace(/_/g, '-')}` : null;
        
        let badges = "";
        if(v.isWeapon) badges += `<span class="badge w">WEP</span>`;
        if(v.wheels === 'F1') badges += `<span class="badge f">F1</span>`;
        if(v.wheels?.includes('Benny')) badges += `<span class="badge b">BNY</span>`;
        
        let pClass = "";
        if(v.plate === "Yankton") pClass = "y";
        else if(v.plate === "Liberty City") pClass = "l";
        else if(v.plate === "Panic") pClass = "p";
        else if(v.plate === "Pounders") pClass = "pd";
        else if(v.plate === "Las Venturas") pClass = "v";
        else if(v.plate === "E-Cola") pClass = "e";
        else if(v.plate === "Sprunk") pClass = "s";
        
        if(pClass) badges += `<span class="badge ${pClass}">${v.plate.toUpperCase()}</span>`;
        else if(v.plate && v.plate !== 'Standard') badges += `<span class="badge">${v.plate}</span>`;

        const div = document.createElement('div'); div.className = "card";
        
        let linkHtml = "";
        if (spawn) {
            linkHtml = `<a href="${gtaUrl}" target="_blank" class="action-btn gtacars-link" title="GTACars.net"><i class="fas fa-external-link-alt"></i></a>`;
        }

        const displayClass = (db.class || v.class || '-').replace(/_/g, ' ');

        div.innerHTML = `
            <div class="card-img-box" onclick="openLb('${img}')"><img class="card-img" src="${img}" onerror="handleImgError(this, '${spawn}')"><div class="card-fallback" style="display:none"><i class="fas fa-car"></i></div><div class="card-badges">${badges}</div></div>
            <div class="card-info">
                <div class="card-top">
                    <div class="card-manuf">${v.manuf}</div>
                    <div class="card-model">${v.model}</div>
                </div>
                <div class="card-chips">
                    <span class="chip"><i class="fas fa-tag"></i> ${displayClass}</span>
                    <span class="chip"><i class="fas fa-cog"></i> ${db.drive||v.drive||'-'}</span>
                    <span class="chip"><i class="fas fa-user"></i> ${db.seats||v.seats||'2'}</span>
                </div>
                <div class="card-loc">
                    <i class="fas fa-warehouse"></i>
                    <div class="loc-text">
                        <span>${v.loc}</span>
                        ${v.floor ? `<span class="loc-floor">${v.floor}</span>` : ''}
                    </div>
                </div>
            </div>
            <div class="card-actions-top">
                ${linkHtml}
                <button class="action-btn" onclick="editVehicle(${v.id})"><i class="fas fa-pencil-alt"></i></button>
            </div>`;
        return div;
    }

    // --- LOGIC ---
    function editVehicle(id) {
        editingId = id; const v = vehicles.find(c=>c.id===id); if(!v) return;
        document.getElementById('modalTitle').innerText = "Edit Vehicle";
        document.getElementById('editActions').style.display = 'flex';
        document.getElementById('inManuf').value = v.manuf;
        updateModelDD(v.model); 
        document.getElementById('inModel').value = v.model;
        
        const locSel = document.getElementById('inLoc');
        let matchedVal = ""; Array.from(locSel.options).forEach(opt => { if (opt.value.replace(/\s\(\d+\)$/, "") === v.loc.replace(/\s\(\d+\)$/, "")) matchedVal = opt.value; });
        if(matchedVal) locSel.value = matchedVal; else { locSel.value = 'Custom'; document.getElementById('inLocCustom').value = v.loc; }
        
        document.getElementById('inFloor').value = v.floor||"";
        document.getElementById('inSlot').value = v.slot||"";
        document.getElementById('inWep').checked = v.isWeapon;
        document.getElementById('inWheels').value = v.wheels||"Stock";
        document.getElementById('inPlate').value = v.plate||"Standard";
        document.getElementById('inNotes').value = v.notes||"";
        handleLocChange(); openModal('vehicleModal');
    }

    function saveVehicle() {
        const manuf = document.getElementById('inManuf').value;
        let model = document.getElementById('inModel').value;
        if(model === 'Custom') model = document.getElementById('inModelCustom').value;
        let loc = document.getElementById('inLoc').value;
        if(loc === 'Custom') loc = document.getElementById('inLocCustom').value;
        
        if(!manuf || !model || !loc) return alert("Required: Make, Model, Garage");
        
        let floor = document.getElementById('inFloor').value;

        const db = masterDB.find(d => d.model === model) || {};
        const car = {
            id: editingId || Date.now(), manuf, model, loc,
            floor: floor,
            slot: document.getElementById('inSlot').value,
            isWeapon: document.getElementById('inWep').checked,
            wheels: document.getElementById('inWheels').value,
            plate: document.getElementById('inPlate').value,
            notes: document.getElementById('inNotes').value,
            spawn: db.spawn||"", class: db.class||"", drive: db.drive||"", seats: db.seats||"",
            locNickname: ""
        };
        if(editingId) vehicles[vehicles.findIndex(v => v.id === editingId)] = car;
        else vehicles.push(car);
        saveGarage(); closeModal('vehicleModal');
    }

    function saveGarage() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(vehicles));
        localStorage.setItem('gta_last_sale', lastSell);
        localStorage.setItem('gta_last_sold_name', lastSoldName);
        render(); updateTimerLogic();
    }

    function openStats() {
        openModal('statsModal');
        document.getElementById('stTotal').innerText = vehicles.length;
        document.getElementById('stWep').innerText = vehicles.filter(v=>v.isWeapon).length || 0;
        document.getElementById('stF1').innerText = vehicles.filter(v=>v.wheels==='F1').length || 0;
        document.getElementById('stBenny').innerText = vehicles.filter(v=>v.wheels?.includes('Benny')).length || 0;
        
        const bCounts = {}; vehicles.forEach(v => { const b = v.manuf || 'Unk'; bCounts[b] = (bCounts[b]||0)+1; });
        document.getElementById('stBrands').innerHTML = Object.entries(bCounts).sort((x,y)=>y[1]-x[1]).slice(0,5).map(x=>`<li>${x[0]}: ${x[1]}</li>`).join('');
        
        let tCap = 0;
        [...new Set(vehicles.map(v=>v.loc))].forEach(l => {
            const cl = Object.keys(CAPACITIES).find(m => l.includes(m)) || "DEFAULT";
            tCap += CAPACITIES[cl];
        });
        document.getElementById('usageTxt').innerText = `${vehicles.length} / ${tCap}`;
        document.getElementById('stEmptySlots').innerText = Math.max(0, tCap - vehicles.length);
        document.getElementById('usageBar').style.width = Math.min((vehicles.length/(tCap||1))*100, 100) + "%";
    }

    function updateTimerLogic() {
        const diff = Date.now() - lastSell, cd = 18 * 3600000, btn = document.getElementById('timerBtn'), disp = document.getElementById('timerBigDisplay'), next = document.getElementById('dashNext');
        document.getElementById('dashLast').innerText = lastSoldName;
        if(diff < cd) {
            btn.innerHTML = 'â³'; btn.classList.add('active');
            const rem = cd - diff, h = Math.floor(rem/3600000), m = Math.floor((rem%3600000)/60000), s = Math.floor((rem%60000)/1000);
            if(disp) { disp.innerText = `${h}h ${m}m ${s}s`; disp.style.color = "var(--timer)"; next.innerText = "Ready at: " + new Date(lastSell + cd).toLocaleTimeString(); }
        } else {
            btn.innerHTML = 'ðŸ’²'; btn.classList.remove('active');
            if(disp) { disp.innerText = "READY"; disp.style.color = "var(--sell)"; next.innerText = "Sale window is open."; }
        }
    }

    // --- UTILS & FEEDBACK ---
    function showSuccess(title, msg) {
        document.getElementById('successTitle').innerText = title;
        document.getElementById('successMsg').innerHTML = msg;
        openModal('successModal');
    }

    function clearSearch() { document.getElementById('searchInput').value = ''; render(); }
    
    // REVERTED TO STANDARD SELECTS
    function populateDropdowns() {
        const manufList = document.getElementById('inManuf');
        const locList = document.getElementById('inLoc');
        
        const uniqueBrands = [...new Set(masterDB.map(c => c.manuf))].sort();
        manufList.innerHTML = `<option value="">Select Make</option>` + uniqueBrands.map(b => `<option value="${b}">${b}</option>`).join('') + `<option value="Custom">Custom...</option>`;
        
        let locOpts = `<option value="">Select Garage</option>`; 
        GARAGE_DATA.forEach(g => { 
            locOpts += `<optgroup label="${g.grp}">` + g.items.map(i => `<option value="${i}">${i}</option>`).join('') + `</optgroup>`; 
        });
        locOpts += `<option value="Custom">Custom...</option>`;
        locList.innerHTML = locOpts;
        
        const moveSel = document.getElementById('moveDest'), swapFrom = document.getElementById('saFrom'), swapTo = document.getElementById('saTo');
        moveSel.innerHTML = locOpts; swapFrom.innerHTML = locOpts; swapTo.innerHTML = locOpts;
    }

    function updateModelDD(sel) {
        const brand = document.getElementById('inManuf').value;
        const dd = document.getElementById('inModel');
        dd.innerHTML = `<option value="">Select Model</option>`;
        
        if (brand === 'Custom') {
            checkCustomModel();
        } else {
            masterDB.filter(c => c.manuf === brand).forEach(c => dd.innerHTML += `<option value="${c.model}">${c.model}</option>`);
            dd.innerHTML += `<option value="Custom">Custom...</option>`;
        }
        if(sel) dd.value = sel;
    }

    function handleLocChange() {
        const v = document.getElementById('inLoc').value;
        const clean = Object.keys(CAPACITIES).find(m => v.includes(m)) || "DEFAULT";
        const dl = document.getElementById('inFloor'); 
        dl.innerHTML = "";
        
        const key = Object.keys(FLOOR_MAP).find(k => v.includes(k));
        if (key) {
            FLOOR_MAP[key].forEach(f => dl.innerHTML += `<option value="${f}">${f}</option>`);
            document.getElementById('floorRow').style.display = 'flex';
        } else if (CAPACITIES[clean] >= 20) {
            // Manual entry for large garages without maps
            dl.innerHTML = `<option value="Floor 1">Floor 1</option><option value="Floor 2">Floor 2</option><option value="Floor 3">Floor 3</option>`;
            document.getElementById('floorRow').style.display = 'flex';
        } else {
            document.getElementById('floorRow').style.display = 'none';
        }
        document.getElementById('inLocCustom').style.display = (v === 'Custom') ? 'block' : 'none';
    }

    function sellVehicle() { if(confirm("Sell?")) { lastSell=Date.now(); lastSoldName=vehicles.find(c=>c.id===editingId).model; vehicles=vehicles.filter(v=>v.id!==editingId); saveGarage(); closeModal('vehicleModal'); } }
    function deleteVehicle() { if(confirm("Delete?")) { vehicles=vehicles.filter(v=>v.id!==editingId); saveGarage(); closeModal('vehicleModal'); } }
    function startMove() { movingId = editingId; document.getElementById('moveCarName').innerText = vehicles.find(v=>v.id===editingId).model; openModal('moveModal'); closeModal('vehicleModal'); }
    function checkMoveCap() { const d = document.getElementById('moveDest').value, cl = Object.keys(CAPACITIES).find(m => d.includes(m)) || "DEFAULT"; if(vehicles.filter(v=>v.loc===d).length >= CAPACITIES[cl]) { document.getElementById('moveSwapUI').style.display='block'; document.getElementById('moveSwapTarget').innerHTML = vehicles.filter(v=>v.loc===d).map(v=>`<option value="${v.id}">${v.model}</option>`).join(''); } else document.getElementById('moveSwapUI').style.display='none'; }
    
    function commitMove() { 
        if(!confirm("Confirm Move?")) return;
        const d = document.getElementById('moveDest').value, carA = vehicles.find(v=>v.id===movingId);
        let msg = `Moved <strong>${carA.model}</strong> to ${d}.`;
        if(document.getElementById('moveSwapUI').style.display!=='none') { 
            const carB = vehicles.find(v=>v.id==document.getElementById('moveSwapTarget').value); 
            const tmp = carA.loc; carA.loc = d; carB.loc = tmp; 
            msg = `Swapped <strong>${carA.model}</strong> with <strong>${carB.model}</strong>.`;
        } else carA.loc = d; 
        saveGarage(); closeMoveModal(); showSuccess("Vehicle Moved", msg);
    }

    function performSwapAll() {
        const f = document.getElementById('saFrom').value, t = document.getElementById('saTo').value;
        if(!f || !t || f === t) return alert("Select different garages");
        if(confirm(`Swap contents?`)) {
            let countA = 0, countB = 0;
            vehicles.forEach(v => { if(v.loc === f) { v.loc = "SW_TMP"; countA++; } });
            vehicles.forEach(v => { if(v.loc === t) { v.loc = f; countB++; } });
            vehicles.forEach(v => { if(v.loc === "SW_TMP") v.loc = t; });
            saveGarage(); closeModal('swapAllModal');
            showSuccess("Garage Swap Complete", `Moved ${countA} vehicles to ${t}<br>Moved ${countB} vehicles to ${f}`);
        }
    }

    function runMigration() { 
        if(!confirm("Start Migration?")) return;
        let c=0, f=0; const log = document.getElementById('migLog'); 
        vehicles = vehicles.map(v => { 
            const m = masterDB.find(db => db.model.toLowerCase() === v.model.toLowerCase()); 
            if(m && !v.spawn) { c++; return {...v, spawn: m.spawn, class: m.class, drive: m.drive, seats: m.seats}; } 
            if(!m) { f++; log.innerHTML += `<div style='color:#e74c3c'>Failed: ${v.model}</div>`; }
            return v; 
        }); 
        saveGarage(); 
        log.innerHTML += `<br>Updated ${c} cars successfully.`; 
    }
    
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function closeMoveModal() { closeModal('moveModal'); }
    
    function openAddModal() { 
        editingId = null; 
        document.getElementById('modalTitle').innerText = "Add Vehicle";
        document.getElementById('editActions').style.display = 'none';
        
        document.getElementById('inManuf').value = "";
        document.getElementById('inModel').innerHTML = ""; // Reset models
        document.getElementById('inLoc').value = "";
        document.getElementById('inFloor').innerHTML = "";
        document.getElementById('inSlot').value = "";
        document.getElementById('inWep').checked = false;
        document.getElementById('inWheels').value = "Stock";
        document.getElementById('inPlate').value = "Standard";
        document.getElementById('inNotes').value = "";
        document.getElementById('inModelCustom').style.display = 'none';
        document.getElementById('inLocCustom').style.display = 'none';
        
        handleLocChange();
        openModal('vehicleModal'); 
    }
    
    function openTimerModal() { openModal('timerModal'); updateTimerLogic(); if(timerInt) clearInterval(timerInt); timerInt=setInterval(updateTimerLogic,1000); }
    function closeTimerModal() { closeModal('timerModal'); if(timerInt) clearInterval(timerInt); }
    function openSwapAllModal() { openModal('swapAllModal'); }
    function openLb(s) { document.getElementById('lbImg').src=s; openModal('lightbox'); }
    function downloadBackup() { const b=new Blob([JSON.stringify(vehicles)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`gta_garage.json`; a.click(); }
    function restoreBackup(i) { const f=i.files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ vehicles=JSON.parse(e.target.result); saveGarage(); location.reload(); }; r.readAsText(f); }
    function factoryReset() { if(confirm("Wipe all data?")) { localStorage.clear(); location.reload(); } }
    function handleImgError(i, s) { if(!i.retry) { i.retry=1; i.src=`${BASE_URL}vehicles/${s.charAt(0).toUpperCase()+s.slice(1).toLowerCase()}.png`; } else { i.style.display='none'; i.nextElementSibling.style.display='block'; } }
    window.onclick = e => { if(e.target.className === 'modal') e.target.style.display = 'none'; }
    function checkCustomModel() { document.getElementById('inModelCustom').style.display = document.getElementById('inModel').value==='Custom'?'block':'none'; }
</script>

</body>
</html>
